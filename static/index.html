<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackbox Target Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .form-label { font-weight: 500; }
        .protocol-fields { margin-top: 15px; }
        .action-buttons { white-space: nowrap; }
        .table-container { overflow-x: auto; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-enabled { background-color: #28a745; }
        .status-disabled { background-color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Blackbox Target Manager</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Add Target Form -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        Add New Target
                    </div>
                    <div class="card-body">
                        <form id="targetForm">
                            <div class="mb-3">
                                <label for="protocol" class="form-label">Protocol</label>
                                <select class="form-select" id="protocol" required>
                                    <option value="">Select Protocol</option>
                                    <option value="http">HTTP</option>
                                    <option value="icmp">ICMP</option>
                                    <option value="tcp">TCP</option>
                                </select>
                            </div>

                            <!-- Common Fields -->
                            <div class="mb-3">
                                <label for="hostname" class="form-label">Hostname</label>
                                <input type="text" class="form-control" id="hostname" required>
                            </div>
                            <div class="mb-3">
                                <label for="module" class="form-label">Module</label>
                                <input type="text" class="form-control" id="module" required>
                            </div>
                            <div class="mb-3">
                                <label for="team" class="form-label">Team</label>
                                <input type="text" class="form-control" id="team" required>
                            </div>
                            <div class="mb-3">
                                <label for="region" class="form-label">Region</label>
                                <input type="text" class="form-control" id="region" required>
                            </div>
                            <div class="mb-3">
                                <label for="assignees" class="form-label">Assignees</label>
                                <input type="text" class="form-control" id="assignees" placeholder="Comma-separated list" required>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" required>
                            </div>

                            <!-- Protocol-specific fields -->
                            <div id="protocol-specific-fields" class="protocol-fields"></div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enabled" checked>
                                <label class="form-check-label" for="enabled">
                                    Enabled
                                </label>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Add Target</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Target List -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Target List</span>
                        <div>
                            <select id="protocolFilter" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                                <option value="all">All Protocols</option>
                                <option value="http">HTTP</option>
                                <option value="icmp">ICMP</option>
                                <option value="tcp">TCP</option>
                            </select>
                            <button id="refreshButton" class="btn btn-sm btn-outline-secondary ms-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                </svg>
                            </button>
                            <button id="enableSelected" class="btn btn-sm btn-success ms-1" disabled>Enable Selected</button>
                            <button id="disableSelected" class="btn btn-sm btn-warning ms-1" disabled>Disable Selected</button>
                            <button id="deleteSelected" class="btn btn-sm btn-danger ms-1" disabled>Delete Selected</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" class="form-check-input">
                                        </th>
                                        <th>Protocol</th>
                                        <th>Hostname</th>
                                        <th>Team</th>
                                        <th>Address</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="targetsList">
                                    <!-- Target entries will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Target</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit-id">
                        <input type="hidden" id="edit-protocol">
                        
                        <div class="mb-3">
                            <label for="edit-hostname" class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="edit-hostname" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-module" class="form-label">Module</label>
                            <input type="text" class="form-control" id="edit-module" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-team" class="form-label">Team</label>
                            <input type="text" class="form-control" id="edit-team" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-region" class="form-label">Region</label>
                            <input type="text" class="form-control" id="edit-region" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-assignees" class="form-label">Assignees</label>
                            <input type="text" class="form-control" id="edit-assignees" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="edit-address" required>
                        </div>

                        <!-- Protocol specific fields for edit -->
                        <div id="edit-protocol-specific-fields"></div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="edit-enabled">
                            <label class="form-check-label" for="edit-enabled">
                                Enabled
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEditButton">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Are you sure you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let targets = {
            http: [],
            icmp: [],
            tcp: []
        };
        let selectedTargets = [];
        let editingTarget = null;
        let pollingInterval = null;
        const pollInterval = 180000; // 3 minutes in milliseconds

        // DOM Elements
        const protocolSelect = document.getElementById('protocol');
        const protocolSpecificFields = document.getElementById('protocol-specific-fields');
        const targetForm = document.getElementById('targetForm');
        const targetsList = document.getElementById('targetsList');
        const protocolFilter = document.getElementById('protocolFilter');
        const refreshButton = document.getElementById('refreshButton');
        const selectAllCheckbox = document.getElementById('selectAll');
        const enableSelectedButton = document.getElementById('enableSelected');
        const disableSelectedButton = document.getElementById('disableSelected');
        const deleteSelectedButton = document.getElementById('deleteSelected');
        
        // Modals
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const saveEditButton = document.getElementById('saveEditButton');
        const confirmActionButton = document.getElementById('confirmActionButton');

        // Protocol specific fields generator
        function generateProtocolFields(protocol, container, prefix = '') {
            container.innerHTML = '';
            
            if (protocol === 'tcp') {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label for="${prefix}port" class="form-label">Port</label>
                    <input type="number" class="form-control" id="${prefix}port" min="1" max="65535" required>
                `;
                container.appendChild(div);
            }
            // Add fields for other protocols if needed
        }

        // Event Listeners
        protocolSelect.addEventListener('change', function() {
            generateProtocolFields(this.value, protocolSpecificFields);
        });

        // Load all targets on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllTargets();
            startPolling();
        });

        // Load all targets
        async function loadAllTargets() {
            try {
                const protocols = ['http', 'icmp', 'tcp'];
                for (const protocol of protocols) {
                    const response = await fetch(`/api/targets/${protocol}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Transform the data format to match our internal structure
                        const formattedData = data.map(item => {
                            const target = {
                                protocol: protocol,
                                address: item.targets[0],
                                enabled: true, // Assuming all returned targets are enabled
                                ...item.labels
                            };
                            return target;
                        });
                        targets[protocol] = formattedData;
                    }
                }
                renderTargetsList();
            } catch (error) {
                console.error('Error loading targets:', error);
                alert('Failed to load targets. Please try again.');
            }
        }

        // Render targets list based on filter
        function renderTargetsList() {
            targetsList.innerHTML = '';
            const filter = protocolFilter.value;
            
            let filteredTargets = [];
            if (filter === 'all') {
                Object.entries(targets).forEach(([protocol, targetList]) => {
                    targetList.forEach(target => {
                        filteredTargets.push({...target, protocol});
                    });
                });
            } else {
                filteredTargets = targets[filter].map(target => ({...target, protocol: filter}));
            }
            
            if (filteredTargets.length === 0) {
                targetsList.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">No targets found</td>
                    </tr>
                `;
                return;
            }
            
            filteredTargets.forEach((target, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input target-checkbox" 
                               data-id="${target.id}" 
                               data-protocol="${target.protocol}">
                    </td>
                    <td>${target.protocol.toUpperCase()}</td>
                    <td>${target.hostname}</td>
                    <td>${target.team}</td>
                    <td>${target.address}</td>
                    <td>
                        <span class="status-indicator ${target.enabled ? 'status-enabled' : 'status-disabled'}"></span>
                        ${target.enabled ? 'Enabled' : 'Disabled'}
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary edit-btn" 
                                data-id="${target.id}" 
                                data-protocol="${target.protocol}">Edit</button>
                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                data-id="${target.id}" 
                                data-protocol="${target.protocol}">Delete</button>
                    </td>
                `;
                targetsList.appendChild(row);
            });
            
            // Attach event listeners to buttons
            attachTargetActionListeners();
        }

        // Add target form submission
        targetForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const protocol = protocolSelect.value;
            if (!protocol) {
                alert('Please select a protocol');
                return;
            }
            
            // Collect form data
            const targetData = {
                hostname: document.getElementById('hostname').value,
                module: document.getElementById('module').value,
                team: document.getElementById('team').value,
                region: document.getElementById('region').value,
                assignees: document.getElementById('assignees').value,
                address: document.getElementById('address').value,
                enabled: document.getElementById('enabled').checked
            };
            
            // Add protocol-specific fields
            if (protocol === 'tcp') {
                targetData.port = parseInt(document.getElementById('port').value);
            }
            
            try {
                const response = await fetch(`/api/targets/${protocol}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(targetData)
                });
                
                if (response.ok) {
                    // Reset form
                    targetForm.reset();
                    protocolSpecificFields.innerHTML = '';
                    
                    // Reload targets
                    loadAllTargets();
                    alert('Target added successfully!');
                } else {
                    const error = await response.json();
                    alert(`Failed to add target: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error adding target:', error);
                alert('Failed to add target. Please try again.');
            }
        });

        // Polling for updates
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            pollingInterval = setInterval(loadAllTargets, pollInterval);
        }

        // Refresh button
        refreshButton.addEventListener('click', loadAllTargets);

        // Protocol filter change
        protocolFilter.addEventListener('change', renderTargetsList);

        // Attach event listeners to target action buttons
        function attachTargetActionListeners() {
            // Edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const protocol = this.dataset.protocol;
                    openEditModal(id, protocol);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const protocol = this.dataset.protocol;
                    confirmDelete(id, protocol);
                });
            });
            
            // Target checkboxes
            document.querySelectorAll('.target-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedTargets);
            });
        }

        // Handle select all checkbox
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.target-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedTargets();
        });

        // Update selected targets array and button states
        function updateSelectedTargets() {
            selectedTargets = [];
            document.querySelectorAll('.target-checkbox:checked').forEach(checkbox => {
                selectedTargets.push({
                    id: checkbox.dataset.id,
                    protocol: checkbox.dataset.protocol
                });
            });
            
            const hasSelected = selectedTargets.length > 0;
            enableSelectedButton.disabled = !hasSelected;
            disableSelectedButton.disabled = !hasSelected;
            deleteSelectedButton.disabled = !hasSelected;
        }

        // Batch operations
        enableSelectedButton.addEventListener('click', function() {
            confirmBatchOperation('enable');
        });

        disableSelectedButton.addEventListener('click', function() {
            confirmBatchOperation('disable');
        });

        deleteSelectedButton.addEventListener('click', function() {
            confirmBatchOperation('delete');
        });

        // Confirm batch operation
        function confirmBatchOperation(operation) {
            const actions = {
                'enable': 'enable',
                'disable': 'disable',
                'delete': 'delete'
            };
            
            document.getElementById('confirmModalLabel').textContent = `Confirm ${operation.charAt(0).toUpperCase() + operation.slice(1)}`;
            document.getElementById('confirmModalBody').textContent = `Are you sure you want to ${operation} ${selectedTargets.length} selected target(s)?`;
            
            confirmActionButton.dataset.operation = operation;
            confirmModal.show();
        }

        // Perform batch operation
        confirmActionButton.addEventListener('click', async function() {
            const operation = this.dataset.operation;
            
            try {
                for (const target of selectedTargets) {
                    if (operation === 'delete') {
                        await fetch(`/api/targets/${target.protocol}/${target.id}`, {
                            method: 'DELETE'
                        });
                    } else {
                        await fetch(`/api/targets/${target.protocol}/${target.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                enabled: operation === 'enable'
                            })
                        });
                    }
                }
                
                // Reload targets and reset selection
                loadAllTargets();
                selectedTargets = [];
                selectAllCheckbox.checked = false;
                enableSelectedButton.disabled = true;
                disableSelectedButton.disabled = true;
                deleteSelectedButton.disabled = true;
                
                confirmModal.hide();
                alert(`${operation.charAt(0).toUpperCase() + operation.slice(1)} operation completed successfully!`);
            } catch (error) {
                console.error(`Error performing ${operation} operation:`, error);
                alert(`Failed to ${operation} targets. Please try again.`);
                confirmModal.hide();
            }
        });

        // Open edit modal
        function openEditModal(id, protocol) {
            // Find the target to edit
            const target = targets[protocol].find(t => t.id == id);
            if (!target) {
                alert('Target not found');
                return;
            }
            
            editingTarget = { ...target, protocol };
            
            // Populate form fields
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-protocol').value = protocol;
            document.getElementById('edit-hostname').value = target.hostname;
            document.getElementById('edit-module').value = target.module;
            document.getElementById('edit-team').value = target.team;
            document.getElementById('edit-region').value = target.region;
            document.getElementById('edit-assignees').value = target.assignees;
            document.getElementById('edit-address').value = target.address;
            document.getElementById('edit-enabled').checked = target.enabled;
            
            // Generate protocol-specific fields
            const editProtocolSpecificFields = document.getElementById('edit-protocol-specific-fields');
            generateProtocolFields(protocol, editProtocolSpecificFields, 'edit-');
            
            // Populate protocol-specific fields
            if (protocol === 'tcp' && target.port) {
                document.getElementById('edit-port').value = target.port;
            }
            
            editModal.show();
        }

        // Save edit changes
        saveEditButton.addEventListener('click', async function() {
            const id = document.getElementById('edit-id').value;
            const protocol = document.getElementById('edit-protocol').value;
            
            // Collect updated data
            const updatedData = {
                hostname: document.getElementById('edit-hostname').value,
                module: document.getElementById('edit-module').value,
                team: document.getElementById('edit-team').value,
                region: document.getElementById('edit-region').value,
                assignees: document.getElementById('edit-assignees').value,
                address: document.getElementById('edit-address').value,
                enabled: document.getElementById('edit-enabled').checked
            };
            
            // Add protocol-specific fields
            if (protocol === 'tcp') {
                updatedData.port = parseInt(document.getElementById('edit-port').value);
            }
            
            try {
                const response = await fetch(`/api/targets/${protocol}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });
                
                if (response.ok) {
                    editModal.hide();
                    loadAllTargets();
                    alert('Target updated successfully!');
                } else {
                    const error = await response.json();
                    alert(`Failed to update target: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating target:', error);
                alert('Failed to update target. Please try again.');
            }
        });

        // Confirm delete
        function confirmDelete(id, protocol) {
            document.getElementById('confirmModalLabel').textContent = 'Confirm Delete';
            document.getElementById('confirmModalBody').textContent = 'Are you sure you want to delete this target?';
            
            confirmActionButton.dataset.operation = 'delete-single';
            confirmActionButton.dataset.id = id;
            confirmActionButton.dataset.protocol = protocol;
            
            confirmModal.show();
        }

        // Delete single target
        confirmActionButton.addEventListener('click', async function() {
            if (this.dataset.operation === 'delete-single') {
                const id = this.dataset.id;
                const protocol = this.dataset.protocol;
                
                try {
                    const response = await fetch(`/api/targets/${protocol}/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        confirmModal.hide();
                        loadAllTargets();
                        alert('Target deleted successfully!');
                    } else {
                        const error = await response.json();
                        alert(`Failed to delete target: ${error.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error deleting target:', error);
                    alert('Failed to delete target. Please try again.');
                }
            }
        });
    </script>
</body>
</html>
